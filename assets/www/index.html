<html>
	<head>
		<script src="file:///android_asset/www/js/cordova-1.5.0.js"></script>
		<script src="file:///android_asset/www/js/UPnP_Plugin.js"></script>
		<script src="file:///android_asset/www/js/pee_plugin.js"></script>
		<script src="file:///android_asset/www/js/soapclient.js"></script>
		<script src="file:///android_asset/www/js/encoder.js"></script>
		<script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
		<script src="file:///home/ludo/workspace/ASK_Sense_combi_app/assets/www/js/soapclient.js"></script>
		<script>
			var myID = "Unknown";
			document.addEventListener('deviceready', function() {
				console.log("phoneGapAvailable to True!");
				phoneGapAvailable = true;
				window.plugins.pee.getImei(function(res){
					myID = res;
					window.plugins.UPNP_Plugin.initUPNP(myID,'Paige Device: '+myID);
					window.plugins.UPNP_Plugin.registerStateVar('IMEI',[]);
					window.plugins.UPNP_Plugin.registerAction('getIMEI',false,['IMEI'],[]);
					window.plugins.UPNP_Plugin.registerStateVar('NM_saddr',[]);
					window.plugins.UPNP_Plugin.registerAction('registerNM',true,['NM_saddr'],[]);
					window.plugins.UPNP_Plugin.registerStateVar('JSON_IN',[]);
					window.plugins.UPNP_Plugin.registerStateVar('JSON_OUT',[]);
					window.plugins.UPNP_Plugin.registerAction('callJSONRPC',true,['JSON_IN'],['JSON_OUT']);					
				});
			});
			
			callJSONRPC = function(arguments){
				console.log("CallJSONRPC called: "+ arguments);
				var decoded = Encoder.htmlDecode(arguments[0]["JSON_IN"]);
				decoded = JSON.parse(decoded);
				console.log(JSON.stringify(decoded));
				return [["JSON_OUT","{\"id\":"+decoded["id"]+",\"result\":\"Hello world\",\"error\":null}"]];
			}
			
			getIMEI = function(arguments){
				console.log("GetIMEI called: "+arguments);
				console.log(myID);
				return [["IMEI",myID]];
			}
			
			registerNM = function(arguments){
				console.log("RegisterNM called: "+arguments[0]['NM_saddr']);
				return [[]];
			}
			
			UPNPCall = function(direction,arguments){
				console.log("UPNPCall invoked:"+direction+ ":" + arguments);
				arguments = JSON.parse(arguments);

				functionName = arguments[0];
				givenArguments = arguments[1];
				
				return window[functionName](givenArguments);
			}
			
			callback = function(res){
				console.log(res);
			}
			
			testSoap = function(){
				var p1 = new SOAPClientParameters();
				p1.add("error", 101);
				p1.add("service","createNode");
				SOAPClient.invoke("http://ask70.ask-cs.nl/~ludo/ludoDev/webservices/","getError",p1,true,callback);
			}
			
			runDiscovery = function(){
				window.plugins.UPNP_Plugin.runDiscovery(["urn:schemas-upnp-org:device:CHAP:1"]);
				
				window.plugins.UPNP_Plugin.listDevices(function(res){
					var target;
					for (var i=0; i< res.length; i++){
						target = res[i];
						if (res[i].root.device.UDN != 'uuid:'+myID){
							console.log("Other device found, I like that one more than my own....:)");
							break;
						}
					}
					console.log(target.root.device.UDN);
					baseURL = target.baseURL.replace("/ddd.xml","");
					controlURL = baseURL+target.root.device.serviceList.service.controlURL;
					SCPDURL = baseURL+target.root.device.serviceList.service.SCPDURL 
					window.plugins.UPNP_Plugin.runAction(controlURL,"urn:upnp-org:serviceId:chap","getIMEI",function(r){
						console.log(JSON.stringify(r));
						console.log("imei result: "+r.IMEI);
					});
					
					window.plugins.UPNP_Plugin.getDescription(SCPDURL,function(r){
						console.log(JSON.stringify(r));
						console.log(r.scpd.actionList.action.name);
					});
				});
				
			}
		</script>
	</head>
	<body>
		Test page!<br>
		Running initUpnp.... With plugin test, not starting on boot<br>
		<button onClick="window.plugins.UPNP_Plugin.stop()">Stop Server</button><br>
		<button onClick="window.plugins.UPNP_Plugin.start()">Start Server</button><br>
		<button onClick="testSoap()">testSoap</button><br>
		<button onClick="runDiscovery()">runDiscovery</button><br>
		
	</body>
</html>